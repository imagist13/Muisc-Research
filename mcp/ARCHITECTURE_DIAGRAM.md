# 🎵 歌单推荐系统架构图

## 简化架构视图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户请求                                  │
│  "给我推荐一个适合运动的歌单"                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              MusicRecommendationAgent                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. analyze_intent()                                  │   │
│  │     → 识别: create_playlist_by_activity               │   │
│  │     → 参数: {activity: "运动"}                        │   │
│  └──────────────────────┬───────────────────────────────┘   │
│                         │                                     │
│  ┌──────────────────────▼───────────────────────────────┐   │
│  │  2. analyze_user_preferences_node() ⭐ NEW           │   │
│  │     → 获取用户 top tracks/artists                    │   │
│  │     → 分析偏好（流派、艺术家）                        │   │
│  └──────────────────────┬───────────────────────────────┘   │
│                         │                                     │
│  ┌──────────────────────▼───────────────────────────────┐   │
│  │  3. enhanced_recommendations_node() ⭐ NEW            │   │
│  │     → Spotify 推荐 API                               │   │
│  │     → 结合用户偏好过滤                                │   │
│  └──────────────────────┬───────────────────────────────┘   │
│                         │                                     │
│  ┌──────────────────────▼───────────────────────────────┐   │
│  │  4. create_playlist_node() ⭐ NEW                    │   │
│  │     → 平衡歌单（流派、艺术家）                        │   │
│  │     → 创建 Spotify 播放列表                           │   │
│  └──────────────────────┬───────────────────────────────┘   │
│                         │                                     │
│  ┌──────────────────────▼───────────────────────────────┐   │
│  │  5. generate_explanation()                           │   │
│  │     → 生成自然语言解释                                │   │
│  └──────────────────────┬───────────────────────────────┘   │
└─────────────────────────┼─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              MCPClientAdapter ⭐ NEW                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • search_tracks()                                    │   │
│  │  • get_recommendations()                             │   │
│  │  • get_user_top_tracks()                             │   │
│  │  • create_playlist()                                 │   │
│  │  • analyze_playlist()                                │   │
│  └──────────────────────┬───────────────────────────────┘   │
└─────────────────────────┼─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│         MCP Music Server (music_server_updated_2025.py)      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  MCP Tools:                                           │   │
│  │  • search_tracks                                      │   │
│  │  • get_recommendations                                │   │
│  │  • create_playlist                                    │   │
│  │  • generate_balanced_playlist                         │   │
│  │  • analyze_playlist                                   │   │
│  │  • get_top_artists_from_collection                    │   │
│  └──────────────────────┬───────────────────────────────┘   │
└─────────────────────────┼─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Spotify Web API                           │
│  (通过 spotipy 库)                                            │
└─────────────────────────────────────────────────────────────┘
```

## 数据流示例

### 场景：创建"运动歌单"

```
用户输入: "给我推荐一个适合运动的歌单"
    │
    ├─> [意图分析] → {intent: "create_playlist_by_activity", activity: "运动"}
    │
    ├─> [获取用户偏好]
    │   ├─> MCPAdapter.get_user_top_tracks() → [20首热门歌曲]
    │   └─> 分析: 偏好流派=["电子", "摇滚"], 艺术家=["Artist1", "Artist2"]
    │
    ├─> [生成推荐]
    │   ├─> MCPAdapter.get_recommendations(
    │   │       seed_genres=["电子", "摇滚"],
    │   │       seed_tracks=[用户top tracks的前5首]
    │   │   ) → [50首推荐歌曲]
    │   └─> 应用推荐算法过滤 → [30首精选]
    │
    ├─> [平衡歌单]
    │   ├─> 流派平衡: 确保每个流派有代表性
    │   ├─> 艺术家平衡: 每个艺术家最多2首
    │   └─> 最终选择: [30首平衡后的歌曲]
    │
    ├─> [创建播放列表]
    │   └─> MCPAdapter.create_playlist(
    │           name="运动歌单",
    │           songs=[30首歌曲],
    │           description="AI推荐的适合运动的音乐"
    │       ) → PlaylistInfo {id, url, name}
    │
    └─> [生成解释]
        └─> "我为你创建了一个包含30首歌曲的运动歌单，
             结合了你的音乐偏好和Spotify的推荐算法。
             播放列表链接: [Spotify URL]"
```

## 核心组件关系

```
┌─────────────────┐
│  music_agent.py │  ← 主入口
└────────┬────────┘
         │
         ▼
┌─────────────────────┐
│  music_graph.py     │  ← 工作流编排
│  (LangGraph)        │
└────────┬────────────┘
         │
         ├─> analyze_intent
         ├─> search_songs_node
         ├─> generate_recommendations_node
         ├─> create_playlist_node ⭐ NEW
         ├─> analyze_user_preferences_node ⭐ NEW
         └─> generate_explanation
         │
         ▼
┌─────────────────────┐
│  music_tools.py      │  ← 工具层（重构）
│  • MusicSearchTool  │
│  • RecommenderEngine │
└────────┬─────────────┘
         │
         ▼
┌─────────────────────┐
│  mcp_adapter.py      │  ← MCP适配器 ⭐ NEW
│  • MCPClientAdapter  │
│  • SpotifyConverter  │
└────────┬─────────────┘
         │
         ▼
┌─────────────────────┐
│  music_server_*.py   │  ← MCP服务器
│  (MCP Tools)         │
└────────┬─────────────┘
         │
         ▼
┌─────────────────────┐
│  Spotify API         │
└─────────────────────┘
```

## 新增功能对比

| 功能 | 现有 | 增强后 |
|------|------|--------|
| 数据源 | 模拟数据 | ✅ Spotify 真实数据 |
| 搜索歌曲 | ✅ 基础搜索 | ✅ Spotify 搜索 + 智能过滤 |
| 推荐算法 | ✅ 简单规则 | ✅ Spotify API + 算法融合 |
| 创建歌单 | ❌ 不支持 | ✅ 直接创建 Spotify 播放列表 |
| 用户偏好 | ❌ 不支持 | ✅ 从 Spotify 数据学习 |
| 歌单平衡 | ❌ 不支持 | ✅ 流派/艺术家/年代平衡 |
| 歌单分析 | ❌ 不支持 | ✅ 多样性分析、流行度分析 |

## 实现优先级

### 🔴 高优先级（Phase 1-2）
1. MCP 适配器基础实现
2. 重构音乐工具使用真实数据
3. 基础歌单创建功能

### 🟡 中优先级（Phase 3-4）
4. 用户偏好分析
5. 智能推荐融合
6. 歌单平衡算法

### 🟢 低优先级（Phase 5）
7. 缓存优化
8. 性能优化
9. 高级分析功能

